var _uuid=0,_instance;function CloudSpectrum(a){var b={node:"",width:600,height:400,mode:"edit",dragFlag:false,autoSize:false,dragComplete:function(){}};this.cfg=this.merge(b,a);this.eventHandlers=[];this.cache={minW:this.cfg.width,minH:this.cfg.height,maxW:0,maxH:0};this._init()}CloudSpectrum.prototype={constructor:CloudSpectrum,_init:function(){var j=this,d=j.cfg,g=d.width,b=d.height;node=j.dom().query(d.node);node.width(g);node.height(b);var i="cloudSpectrum-"+j._guid(),c="uic-container-"+j._guid();if(d.mode=="edit"){node.css("position","relative");node.html('<div id="'+c+'" class="ui-cloudSpectrum" style="width:'+g+"px; height:"+b+'px; overflow:hidden;position:relative"><div id="'+i+'"></div></div><div id="cp-preview-panel"></div><div id="cp-preview-btn">\u9884\u89c8</div>');j.paper=Raphael(i,g*2,b*2);j.paper.clear();j.cache.center={x:g,y:b};var e=j.dom().query("#"+c);e.get(0).scrollTop=b/2;e.get(0).scrollLeft=g/2;j.paper.rect(g/2,b/2,g,b,10).attr({stroke:"#666"})}else{node.html('<div id="'+c+'" class="ui-cloudSpectrum" style="width:'+g+"px; height:"+b+'px; overflow:hidden"><div id="'+i+'"></div></div>');j.paper=Raphael(i,g,b);j.cache.center={x:g/2,y:b/2}}(j.dom().ua().ie&&parseFloat(j.dom().ua().ie)<9)?j.paper.canvas.className="paper":j.paper.canvas.attributes.drag="paper";if(d.dragFlag){j.dom().query(j.paper.canvas).setDrag()}j.node=node;j.container=j.dom().query("#"+c);Raphael.fn.connection=function(o,m,q){var s;if(o.line&&o.from&&o.to){s=o;o=s.from;m=s.to}var k=o.getBBox(),h=m.getBBox(),l=[{x:k.x+k.width/2,y:k.y+k.height/2},{x:h.x+h.width/2,y:h.y+h.height/2},{x:h.x+h.width/2,y:h.y+h.height/2}],p={x:(l[1].x+l[0].x)/2,y:(l[1].y+l[0].y)/2};var r=["M",l[0].x,l[0].y,"L",l[1].x,l[1].y].join(",");if(s&&s.line){s.line.toBack().attr({path:r});s.lineNode.attr({x:p.x,y:p.y,cx:p.x,cy:p.y})}else{var n=typeof s=="string"?s:"#000";return{line:this.path(r).toBack().attr({stroke:"#C6D9EC","stroke-width":"2px",fill:"none",opacity:0.4}),from:o,to:m,lineNode:j.paper.set().push(this.circle(p.x,p.y,8).attr({fill:"#57cbf2",stroke:"#57cbf2",opacity:0.4}),this.text(p.x,p.y,"?").attr({stroke:"#fff",cursor:"pointer",opacity:0.4})),lineOpt:q}}};if(d.mode=="edit"){var f=1;var a=j.dom().query("#cp-preview-btn");a.bind("click",function(){var h=j.dom().query("#cp-preview-panel");if(f){h.show();a.html("\u7f16\u8f91");h.html("");if(_instance){var k=new CloudSpectrum({node:"#cp-preview-panel",width:g,height:b,mode:"view"});k.render(_instance.preview())}f=0}else{h.hide();h.html("");a.html("\u9884\u89c8");f=1}})}},render:function(O){var g=this,e=g.cfg,b=g.dom(),I=g.paper;g.connections=[],g.shapes=[];g.flatData=[];g.data=O;g.cache.w=e.width;g.cache.h=e.height;g.objects={};var A=g.shapes,j=g.cache,q=g.objects,m=g.flatData;var G={fill:"#5782C2",stroke:"#5782C2"},K={fill:"#fff","font-size":"14px","font-weight":"400"};var Q=Math.round(Math.max(j.w,j.h)/6),a=Math.round(Q/4);g.circleRadius=a;var w=[],M=[],d=1;w.push(O);P(w);if(e.autoSize){p()}var h=false,E,x,c,D=false;function F(){if(this.data("setIndex")){E=A[this.data("setIndex")];c=m[this.data("dataIndex")];var i=E.getBBox();x={};h=true;x.ox=i.x;x.oy=i.y;x.cox=i.x+i.width/2;x.coy=i.y+i.height/2}}function k(s,i){if(h){var S=x.cox+s,R=x.coy+i,r;if(!D){R<a+j.h/2&&(R=a+j.h/2+5);R>(j.h*2-a-j.h/2)&&(R=j.h*2-a-j.h/2-5);S<a+j.w/2&&(S=a+j.w/2+5);S>(j.w*2-a-j.w/2)&&(S=j.w*2-a-j.w/2-5);r={x:S,y:R,cx:S,cy:R};E.attr(r);c.theta=Raphael.rad(Raphael.angle(S,R,j.center.x,j.center.y));c.radius=g._computeLength(j.center.x,j.center.y,S,R);D=true;setTimeout(function(){D=false},40)}}}function C(){if(h){for(var r=v.length;r--;){I.connection(v[r])}I.safari();h=false}}for(var J=0,B=A.length;J<B;J++){var z=Raphael.getColor();var H=A[J];H.attr({cursor:"pointer"});if(e.mode=="edit"){H.attr({cursor:"move"});H.drag(k,F,C)}(function(i){i.mouseover(function(){i.attr({opacity:"0.7"})}).mouseout(function(){i.attr({opacity:"1"})});if(e.mode=="view"){i.click(function(s){var r=this.data("dataIndex");if(r!=undefined){var R=m[r];R.x=s.clientX;R.y=s.clientY;g._publish("nodeClick",{x:s.clientX,y:s.clientY,id:R.id,name:R.name})}})}else{i.dblclick(function(s){var r=this.data("dataIndex");if(r!=undefined){var R=m[r];R.x=s.clientX;R.y=s.clientY;g._publish("nodeClick",{x:s.clientX,y:s.clientY,id:R.id,name:R.name})}})}})(H)}function p(){I.forEach(function(s){s.transform("T"+(5-j.minW).toString()+","+(5-j.minH).toString())});var r=j.maxW-j.minW+20,i=j.maxH-j.minH+20;I.setSize(r,i);g.node.width(r);g.node.height(i);g.container.width(r);g.container.height(i)}var v=[];n(O,O.childNodes);function n(T,S,s){var r=q[T.id];if(S&&S.length){for(var R=0;R<S.length;R++){if(S[R]){var W=S[R],V=W.id,U=q[V];v.push(I.connection(A[r.index],A[U.index],{pid:T.id,pname:T.name,id:V,name:W.name}));n(W,W.childNodes)}}}}for(var J=0,B=v.length;J<B;J++){var t=v[J];(function(i){if(i){i.lineNode.mouseover(function(){i.lineNode.attr({transform:"S1.2 1.2",opacity:"1"});i.from.attr({opacity:"0.7"});i.to.attr({opacity:"0.7"})}).mouseout(function(){i.lineNode.attr({transform:"",opacity:"0.4"});i.from.attr({opacity:"1"});i.to.attr({opacity:"1"})});i.lineNode.click(function(s){var R=s.clientX;var r=s.clientY;g._publish("relationClick",{x:R,y:r,id:i.lineOpt.id,name:i.lineOpt.name,parentId:i.lineOpt.pid,parentName:i.lineOpt.pname})})}})(t)}function P(s){var S=0;while(s.length>0){var T=s.shift();if(T){if(T.parent==0){var r=j.center.x,V=j.center.y;var i=g.shapes.length;var R=l(T.shape+"",[r,V],a*1.2);f([r,V],a*1.2);R.attr({fill:T.color,stroke:T.color}).data("setIndex",i);A.push(I.set().push(R,I.text(r,V,T.name).attr(K).attr({title:T.name,"font-size":(T.name.length>3?"10px":"14px")}).data("setIndex",i).data("dataIndex",i)));q[T.id]={x:r,y:V,theta:0,index:0};T.theta=0;T.radius=0;m.push(g.clone(T));if(T.childNodes.length>0){M.push(T.childNodes.length)}o({x:r,y:V},T.childNodes);s=s.concat(T.childNodes);d++}else{var U=q[T.id];if(S==M[0]){M.shift();S=0;d++;M.push(T.childNodes.length)}else{if(M[1]){M[1]=M[1]+T.childNodes.length}else{T.childNodes&&(M[1]=T.childNodes.length)}}o(U,T.childNodes);s=s.concat(T.childNodes);S++}}}}function o(V,U){if(!(U&&U.length)){return}var r=U.length,S=g._getAverageWeight(U);if(V.theta!==undefined){var s=Math.PI/r;if(d==2){s=Math.PI/10}if(d==3){if(s>Math.PI/24){s=Math.PI/24}}var R=s*(r-1)/2-V.theta;for(var T=0;T<r;T++){u(U[T],V,(d*3.5)*a,-R+T*s)}}else{var s=2*Math.PI/r;for(var T=0;T<r;T++){u(U[T],V,(d*3.5)*a,T*s)}}}function u(r,V,U,s){if(q[r.id]){return}var T=m.length;var i,W=g.shapes.length;if(r.radius&&r.theta){i=g._polarToXY(V,r.radius*a,r.theta)}else{i=g._polarToXY(V,U,s)}var R,S;if(e.mode=="edit"){i[1]<a+j.h/2&&(i[1]=a+j.h/2+5);i[1]>(j.h*2-a-j.h/2)&&(i[1]=j.h*2-a-j.h/2-5);i[0]<a+j.w/2&&(i[0]=a+j.w/2+5);i[0]>(j.w*2-a-j.w/2)&&(i[0]=j.w*2-a-j.w/2-5);R=l("3",i,a).attr({fill:r.color,stroke:r.color}).data("setIndex",W)}else{i[1]<a&&(i[1]=a);i[1]>(j.h-a)&&(i[1]=j.h-a);i[0]<a&&(i[0]=a);i[0]>(j.w-a)&&(i[0]=j.w-a);R=l(r.shape+"",i,a).attr({fill:r.color,stroke:r.color}).data("setIndex",W)}f(i,a);s=Raphael.rad(Raphael.angle(i[0],i[1],j.center.x,j.center.y));S=g._computeLength(j.center.x,j.center.y,i[0],i[1]);A.push(I.set().push(R,I.text(i[0],i[1],r.name).attr(K)).attr({title:r.name,"font-size":(r.name.length>3?"10px":"14px")}).data("setIndex",W).data("dataIndex",T));q[r.id]={x:i[0],y:i[1],theta:s,index:W};r.theta=s;r.radius=S;m.push(g.clone(r))}function l(s,R,r){var i;switch(s){case"1":i=I.rect(R[0]-r,R[1]-r,r*2,r*2);break;case"2":i=I.ellipse(R[0],R[1],r,r*0.6);break;case"3":i=I.circle(R[0],R[1],r);break;case"4":i=y(R[0],R[1],r);break;case"5":i=L(R[0],R[1],r);break;case"6":i=N(R[0],R[1],r);break;case"7":i=I.rect(R[0]-r,R[1]-r,r*2,r*2,10);break;default:i=I.circle(R[0],R[1],r);break}return i}function f(S,r){if(e.autoSize){var T=S[0]+r,s=S[1]+r,i=S[0]-r,R=S[1]-r;j.minW=j.minW<i?j.minW:i;j.minH=j.minH<R?j.minH:R;j.maxW=j.maxW>T?j.maxW:T;j.maxH=j.maxH>s?j.maxH:s}}function L(X,V,T){var Y=T*Math.cos(Math.PI/3),S=T*Math.sin(Math.PI/3);var s=X-S,W=V+Y,r=X+S,U=V+Y,i=X,R=V-T;var Z=["M",s,W,"L",r,U,"L",i,R].join(" ");return I.path(Z)}function y(U,T,af){var V=af*Math.cos(36*Math.PI/180),X=af*Math.sin(36*Math.PI/180),Y=af*Math.cos(18*Math.PI/180),ae=af*Math.sin(18*Math.PI/180);var ad=U-X,S=T+V,ac=U+X,R=T+V,ab=U+Y,s=T-ae,aa=U,r=T-af,Z=U-Y,i=T-ae;var W=["M",ad,S,"L",ac,R,"L",ab,s,"L",aa,r,"L",Z,i].join(" ");return I.path(W)}function N(V,U,af){var W=af*Math.cos(Math.PI/6),ac=af*Math.sin(Math.PI/6);var ae=V-ac,T=U+W,ad=V+ac,S=U+W,ab=V+af,R=U,aa=V+ac,s=U-W,Z=V-ac,r=U-W,Y=V-af,i=U;var X=["M",ae,T,"L",ad,S,"L",ab,R,"L",aa,s,"L",Z,r,"L",Y,i].join(" ");return I.path(X)}},save:function(){var b=this,a=[];for(var c=b.flatData.length-1;c>=0;c--){var d=b.flatData[c];a.push(d)}return a},preview:function(){var c=this,d=c.data,b=c.flatData;function a(e){for(var g=0,h=e.length;g<h;g++){var k=e[g];for(var f=0;f<b.length;f++){if(k.id==b[f].id){k.theta=b[f].theta;k.radius=b[f].radius;break}}a(k.childNodes)}}a([d]);return d},on:function(b,c){var a=this;a.eventHandlers[b]=c},destroy:function(){this._DEFAULT=this.cfg=this.eventHandlers=this.cache=null;this.paper.remove()},_publish:function(c,d){var b=this,a=b.eventHandlers;if(a[c]){a[c].call(b.dom().query(b.cfg.node).elements[0],d)}},_guid:function(){return ++_uuid},_polarToXY:function(g,a,e){var d=this,b=d.cfg,c=d.cache,f=d.circleRadius;return[c.center.x+a*Math.cos(e),c.center.y+a*Math.sin(e)]},_computeLength:function(c,e,b,d){var a=this,f=a.circleRadius;return Math.sqrt((c-b)*(c-b)+(e-d)*(e-d))/f},_getAverageWeight:function(a){if(!a.length){return 0}var d=0;for(var b=0,c=a.length;b<c;b++){d+=a[b].weight}return d/a.length},merge:function(c,b){for(var a in b){c[a]=b[a]}return c},clone:function(c){var b=new Object();for(var a in c){if(Object.prototype.toString.call(c[a])=="[object Array]"){b[a]=[]}else{b[a]=c[a]}}return b},util:{substitute:function(b,a){if(!(Object.prototype.toString.call(b)==="[object String]")){return""}if(!(Object.prototype.toString.call(a)==="[object Object]"&&"isPrototypeOf" in a)){return b}return b.replace(/\{([^{}]+)\}/g,function(c,d){var e=a[d];return(e!==undefined)?""+e:""})}},dom:function(){var a=this;function b(){this.elements=[];c.call(this)}b.prototype={constructor:b,_events:[],query:function(d,h){var g;if(typeof arguments[0]=="string"){g=arguments[0];var k=g.slice(0,1);if(k=="#"){g=document.getElementById(g.slice(1));this.elements.push(g)}else{if(document.querySelectorAll){this.elements.concat(document.querySelectorAll(g,h.elements))}else{var l=document.body.getElementsByTagName("*");for(var f=0,e=l.length;f<e;f++){if(g.indexOf(l[f].className)!=-1){this.elements.push(l[f])}}}}}else{g=d;this.elements.push(g)}return this},get:function(d){return d<this.elements.length?this.elements[d]:null},each:function(f){for(var e=0,d=this.elements.length;e<d;e++){f.call(this,this.elements[e],e)}return this},css:function(e,d){if(d){this.each(function(f){f.style[e]=d})}else{return this.elements[0].style[e]}},width:function(d){if(d){this.elements[0].style.width=d+"px";return this}else{return this.elements[0].offsetWidth}},height:function(d){if(d){this.elements[0].style.height=d+"px";return this}else{return this.elements[0].offsetHeight}},html:function(d){this.elements[0].innerHTML=d},show:function(){this.each(function(d){d.style.display="block"})},hide:function(){this.each(function(d){d.style.display="none"})},ua:function(){var d={};var e=navigator.userAgent.toLowerCase();var f;(f=e.match(/msie ([\d.]+)/))?d.ie=f[1]:(f=e.match(/firefox\/([\d.]+)/))?d.firefox=f[1]:(f=e.match(/chrome\/([\d.]+)/))?d.chrome=f[1]:(f=e.match(/opera.([\d.]+)/))?d.opera=f[1]:(f=e.match(/version\/([\d.]+).*safari/))?d.safari=f[1]:0;return d},setDrag:function(){var h=this;this.css("position","absolute");this.css("left","0px");this.css("top","0px");var d={x:parseInt(this.elements[0].style.left.replace(/px/,""),10),y:parseInt(this.elements[0].style.top.replace(/px/,""),10)};var f={x:0,y:0};var e=function(i){h.elements[0].style.left=i.clientX-d.x+"px";h.elements[0].style.top=i.clientY-d.y+"px"};var g=function(i){a.dom().query(document).unbind("mousemove",e);a.dom().query(document).unbind("mouseup",g);f.offsetX=i.clientX-f.x;f.offsetY=i.clientY-f.y;f.x=i.clientX;f.y=i.clientY;a.cfg.dragComplete.call(h.elements[0],f)};this.bind("mousedown",function(i){if((i.target&&i.target.attributes.drag=="paper")||(i.srcElement&&i.srcElement.className=="paper")){f.x=i.clientX;f.y=i.clientY;d.x=i.clientX-parseInt(h.elements[0].style.left.replace(/px/,""),10);d.y=i.clientY-parseInt(h.elements[0].style.top.replace(/px/,""),10);a.dom().query(document).bind("mousemove",e);a.dom().query(document).bind("mouseup",g)}})},bind:function(f,j){var h=this;this._events[f]=j;for(var e=0,d=this.elements.length;e<d;e++){var g=this.elements[e];if(g.addEventListener){g.addEventListener(f,j,false)}else{if(g.attachEvent){g.attachEvent("on"+f,j)}}}return this},unbind:function(f,h){for(var e=0,d=this.elements.length;e<d;e++){var g=this.elements[e];g.removeEventListener?g.removeEventListener(f,h,false):g.detachEvent("on"+f,h)}},triggle:function(d,e){this.each(this._elements,function(f,g){if(g.fireEvent){g.fireEvent(d,e)}else{if(g.dispatchEvent(event)){g.dispatchEvent(d,e)}}})}};function c(){this.handlers={}}c.prototype={constructor:c,on:function(e,d){this.handlers[e]=[]},fire:function(){if(!event.target){event.target=this}if(this.handlers[event.type instanceof Array]){var e=this.handlers[event.type];for(var f=0,d=e.length;f<d;f++){e[f](event)}}},removeHandler:function(h,g){if(this.handlers[h] instanceof Array){var d=this.handlers[h];for(var f=0,e=d.length;f<len;f++){if(d[f]===g){break}d.splice(f,1)}}}};return new b()}};
